"use strict";var j=Object.defineProperty,q=Object.defineProperties;var Y=Object.getOwnPropertyDescriptors;var v=Object.getOwnPropertySymbols;var B=Object.prototype.hasOwnProperty,Q=Object.prototype.propertyIsEnumerable;var x=(c,a,s)=>a in c?j(c,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):c[a]=s,E=(c,a)=>{for(var s in a||(a={}))B.call(a,s)&&x(c,s,a[s]);if(v)for(var s of v(a))Q.call(a,s)&&x(c,s,a[s]);return c},k=(c,a)=>q(c,Y(a));var _=(c,a,s)=>new Promise((N,T)=>{var I=i=>{try{l(s.next(i))}catch(m){T(m)}},w=i=>{try{l(s.throw(i))}catch(m){T(m)}},l=i=>i.done?N(i.value):Promise.resolve(i.value).then(I,w);l((s=s.apply(c,a)).next())});_(this,null,function*(){"use strict";if(!$.alert){const e=document.createElement("link");e.rel="stylesheet",e.type="text/css";const n=new Promise(r=>e.addEventListener("load",r));e.href="/plugins/jquery-confirm/dist/jquery-confirm.min.css",document.head.appendChild(e);const t=document.createElement("script"),o=new Promise(r=>t.addEventListener("load",r));t.src="/plugins/jquery-confirm/dist/jquery-confirm.min.js",document.head.appendChild(t),yield Promise.all([n,o])}const c="ctdacalendar",a="CTDA Timetable Exporter",s="Asia/Ho_Chi_Minh",N=["T2","T3","T4","T5","T6","T7","CN"],T=/<\s*br\s*\/?\s*>/gu,I={"1/24-25":{theory:{start:new Date("2024-09-30T00:00:00Z"),end:new Date("2024-12-15T00:00:00Z")},practice:{start:new Date("2024-10-07T00:00:00Z"),end:new Date("2024-12-15T00:00:00Z")},breaks:[{start:new Date("2024-11-04T00:00:00Z"),end:new Date("2024-11-10T00:00:00Z")}]},"2/24-25":{theory:{start:new Date("2025-01-06T00:00:00Z"),end:new Date("2025-04-13T00:00:00Z")},practice:{start:new Date("2025-01-13T00:00:00Z"),end:new Date("2025-04-13T00:00:00Z")},breaks:[{start:new Date("2025-01-20T00:00:00Z"),end:new Date("2025-02-09T00:00:00Z")},{start:new Date("2025-03-03T00:00:00Z"),end:new Date("2025-03-09T00:00:00Z")}]},"3/24-25":{theory:{start:new Date("2025-05-12T00:00:00Z"),end:new Date("2025-08-17T00:00:00Z")},practice:{start:new Date("2025-05-19T00:00:00Z"),end:new Date("2025-08-17T00:00:00Z")},breaks:[{start:new Date("2025-06-16T00:00:00Z"),end:new Date("2025-07-13T00:00:00Z")}]}},w=new Intl.DateTimeFormat("vi-VN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1,timeZone:"UTC"}),l=new Intl.DateTimeFormat("vi-VN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1,timeZone:s});function i(e,n){const t={};for(const o of n.formatToParts(e))t[o.type]=o.value;return`${t.year}${t.month}${t.day}T${t.hour}${t.minute}${t.second}`}function m(e,n=0){const t=e.length;let o=75-n,r=e.substring(0,75-n);for(;o<t;){const d=e.substring(o,o+75);r+=`\r
 ${d}`,o+=75}return r}function*A(e){const n=e.split(T);for(const t of n){const o=t.match(new RegExp("(?<dow>T[2-7]|CN) (?<start>\\d{1,2}:\\d{1,2})-(?<end>\\d{1,2}:\\d{1,2}) (?:\\((?<class>.+?)\\))?"));if(!o||o.length!==5)throw new Error(`Schedule was not in correct format: ${t}`);const[r,d,h,g,p]=o,u=N.indexOf(d);if(u===-1)throw new Error(`Unknown weekday: ${d}`);const D=h.split(":");if(D.length!==2)throw new Error(`Cannot parse start hour: ${h}`);const f=D.map(Z=>Number(Z)),M=g.split(":");if(M.length!==2)throw new Error(`Cannot parse end hour: ${g}`);const F=M.map(Z=>Number(Z));yield{weekday:u,startHm:f,endHm:F,location:p!=null?p:null}}}function O(e,n,t){return new Date(+n+t*864e5+(e[0]-7)*36e5+e[1]*6e4)}function K(e,n){const t=new Date(e.valueOf());return t.setDate(e.getDate()+n),t}function L(e,n,t,o=[]){const r=Object.entries(e.extras),d=[];if(r.length!==0){const u=r.map(([D,f])=>`${D}: ${f}`).join("\\n");d.push(`DESCRIPTION:${m(u,13)}`)}const h=[`RRULE:FREQ=WEEKLY;UNTIL=${i(t,w)}`],g=O(e.startHm,n,e.weekday);if(o.length>0){let u=g,D=0;for(;u<t;)o.some(f=>f.start<=u&&u<=f.end)&&(D===0?(h.push(`EXDATE;TZID=${s}`),h.push(` :${i(u,l)}`)):h.push(` ,${i(u,l)}`),D++),u=K(u,7)}const p=["BEGIN:VEVENT",`UID:${crypto.randomUUID()}@${c}`,`DTSTAMP:${i(new Date,w)}`,`SUMMARY:${m(e.name,9)}`,...d];return e.location!==null&&p.push(`LOCATION:${m(e.location,10)}`),p.push(`DTSTART;TZID=${s}:${i(O(e.startHm,n,e.weekday),l)}`,`DTEND;TZID=${s}:${i(O(e.endHm,n,e.weekday),l)}`,...h,"END:VEVENT"),p}function G(e){const n=document.createElement("div");n.innerHTML=e;const t=n.textContent;return n.remove(),t!=null?t:""}if(document.location.pathname!=="/sinh-vien/ket-qua-dkhp"){$.alert({type:"red",title:"Wrong location",content:"You are in the wrong place. To export your timetable, go to https://portal.ctdb.hcmus.edu.vn/sinh-vien/ket-qua-dkhp.",buttons:{ok:{text:"Take me there",btnClass:"btn-blue",action:()=>{document.location="/sinh-vien/ket-qua-dkhp"}},cancel:{text:"Cancel"}}});return}const R=document.querySelector(".ModCTDBSVKetQuaDKHPC");if(!R){$.alert({type:"red",title:"Could not find timetable",content:'Cannot export timetable if it does not exist. If you think this is an error, please <a href="https://github.com/beerpiss/hcmus-ctda-calendar/issues">contact the developer</a>.',buttons:{ok:{text:"OK"}}});return}const b=ko.dataFor(R),C=b.dsKetQuaDKHP();if(console.log(`ketQuaDKHP: ${JSON.stringify(C)}`),C.length===0){$.alert({title:"Nothing to export",content:'Seems like you have no subjects this semester. Have fun! If you think this is an error, please <a href="https://github.com/beerpiss/hcmus-ctda-calendar/issues">contact the developer</a>.',buttons:{ok:{text:"OK"}}});return}const H=["BEGIN:VCALENDAR",`PRODID:-//${c}//${a}//VI`,"VERSION:2.0","BEGIN:VTIMEZONE","TZID:Asia/Ho_Chi_Minh","TZURL:http://tzurl.org/zoneinfo-outlook/Asia/Ho_Chi_Minh","X-LIC-LOCATION:Asia/Ho_Chi_Minh","BEGIN:STANDARD","TZOFFSETFROM:+0700","TZOFFSETTO:+0700","TZNAME:+07","DTSTART:19700101T000000","END:STANDARD","END:VTIMEZONE"];for(const e of C){if(!e.LichHocLT&&!e.LichHocTH)continue;let n=null;const t=I[e.HocKy];if(!t){$.alert({type:"red",title:"Error",content:`Start and end dates for semester ${e.HocKy} has not been added. Please <a href="https://github.com/beerpiss/hcmus-ctda-calendar/issues">contact the developer</a>.`,buttons:{ok:{text:"OK"}}});return}const o={};if(e.GVTroGiang&&(o["Tr\u1EE3 gi\u1EA3ng"]=e.GVTroGiang.replace(T,", ")),e.GhiChu&&(o["Ghi ch\xFA"]=G(e.GhiChu).replace(/^Ghi chÃº:\s*/,"")),e.LichHocLT){const r=`[${e.KyHieu}] [LT] ${e.TenMH}`;for(const d of A(e.LichHocLT))n=k(E({},d),{name:r,extras:E({"Gi\xE1o vi\xEAn":e.GVLyThuyet.replace(T,", ")},o)}),H.push(...L(n,t.theory.start,t.theory.end,t.breaks))}if(e.LichHocTH){const r=`[${e.KyHieu}] [TH] ${e.TenMH}`;for(const d of A(e.LichHocTH))n=k(E({},d),{name:r,extras:E({"Gi\xE1o vi\xEAn":e.GVThucHanh.replace(T,", ")},o)}),H.push(...L(n,t.practice.start,t.practice.end,t.breaks))}}H.push("END:VCALENDAR");const U=H.join(`\r
`),V=b.selectedMaHK(),S=b.dsHocKy().find(e=>e.MaHK===V),P=S?`${S.TenHK}.ics`:"Unknown Semester.ics",y=document.createElement("a");y.href=`data:text/calendar,${encodeURIComponent(U)}`,y.download=P,y.click(),y.remove(),toastr.success("The timetable was successfully exported.")});

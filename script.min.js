"use strict";var j=Object.defineProperty,q=Object.defineProperties;var Y=Object.getOwnPropertyDescriptors;var M=Object.getOwnPropertySymbols;var B=Object.prototype.hasOwnProperty,Q=Object.prototype.propertyIsEnumerable;var v=(c,a,s)=>a in c?j(c,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):c[a]=s,E=(c,a)=>{for(var s in a||(a={}))B.call(a,s)&&v(c,s,a[s]);if(M)for(var s of M(a))Q.call(a,s)&&v(c,s,a[s]);return c},Z=(c,a)=>q(c,Y(a));var x=(c,a,s)=>new Promise((g,T)=>{var N=i=>{try{l(s.next(i))}catch(m){T(m)}},f=i=>{try{l(s.throw(i))}catch(m){T(m)}},l=i=>i.done?g(i.value):Promise.resolve(i.value).then(N,f);l((s=s.apply(c,a)).next())});x(this,null,function*(){"use strict";if(!$.alert){const e=document.createElement("link");e.rel="stylesheet",e.type="text/css";const n=new Promise(r=>e.addEventListener("load",r));e.href="/plugins/jquery-confirm/dist/jquery-confirm.min.css",document.head.appendChild(e);const t=document.createElement("script"),o=new Promise(r=>t.addEventListener("load",r));t.src="/plugins/jquery-confirm/dist/jquery-confirm.min.js",document.head.appendChild(t),yield Promise.all([n,o])}const c="ctdacalendar",a="CTDA Timetable Exporter",s="Asia/Ho_Chi_Minh",g=["T2","T3","T4","T5","T6","T7","CN"],T=/<\s*br\s*\/?\s*>/gu,N={"1/23-24":{theory:{start:new Date("2023-10-02T00:00:00Z"),end:new Date("2023-12-17T00:00:00Z")},practice:{start:new Date("2023-10-09T00:00:00Z"),end:new Date("2023-12-17T00:00:00Z")},breaks:[{start:new Date("2023-11-06T00:00:00Z"),end:new Date("2023-11-12T00:00:00Z")}]},"2/23-24":{theory:{start:new Date("2024-01-08T00:00:00Z"),end:new Date("2024-04-14T00:00:00Z")},practice:{start:new Date("2024-01-15T00:00:00Z"),end:new Date("2024-04-14T00:00:00Z")},breaks:[{start:new Date("2024-01-29T00:00:00Z"),end:new Date("2024-02-18T00:00:00Z")},{start:new Date("2024-03-04T00:00:00Z"),end:new Date("2024-03-10T00:00:00Z")}]},"3/23-24":{theory:{start:new Date("2024-05-13T00:00:00Z"),end:new Date("2024-08-18T00:00:00Z")},practice:{start:new Date("2024-05-20T00:00:00Z"),end:new Date("2024-08-18T00:00:00Z")},breaks:[{start:new Date("2024-06-17T00:00:00Z"),end:new Date("2024-07-14T00:00:00Z")}]}},f=new Intl.DateTimeFormat("vi-VN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1,timeZone:"UTC"}),l=new Intl.DateTimeFormat("vi-VN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1,timeZone:s});function i(e,n){const t={};for(const o of n.formatToParts(e))t[o.type]=o.value;return`${t.year}${t.month}${t.day}T${t.hour}${t.minute}${t.second}`}function m(e,n=0){const t=e.length;let o=75-n,r=e.substring(0,75-n);for(;o<t;){const d=e.substring(o,o+75);r+=`\r
 ${d}`,o+=75}return r}function*k(e){const n=e.split(T);for(const t of n){const o=t.match(new RegExp("(?<dow>T[2-7]|CN) (?<start>\\d{1,2}:\\d{1,2})-(?<end>\\d{1,2}:\\d{1,2}) \\((?<class>.+?)\\)"));if(!o||o.length!==5)throw new Error(`Schedule was not in correct format: ${t}`);const[r,d,h,H,u]=o,p=g.indexOf(d);if(p===-1)throw new Error(`Unknown weekday: ${d}`);const D=h.split(":");if(D.length!==2)throw new Error(`Cannot parse start hour: ${h}`);const P=D.map(C=>Number(C)),L=H.split(":");if(L.length!==2)throw new Error(`Cannot parse end hour: ${H}`);const F=L.map(C=>Number(C));yield{weekday:p,startHm:P,endHm:F,location:u}}}function I(e,n,t){return new Date(+n+t*864e5+(e[0]-7)*36e5+e[1]*6e4)}function _(e,n){const t=new Date(e.valueOf());return t.setDate(e.getDate()+n),t}function A(e,n,t,o=[]){const r=Object.entries(e.extras),d=[];if(r.length!==0){const u=r.map(([p,D])=>`${p}: ${D}`).join("\\n");d.push(`DESCRIPTION:${m(u,13)}`)}const h=[`RRULE:FREQ=WEEKLY;UNTIL=${i(t,f)}`],H=I(e.startHm,n,e.weekday);if(o.length>0){let u=H,p=0;for(;u<t;)o.some(D=>D.start<=u&&u<=D.end)&&(p===0?(h.push(`EXDATE;TZID=${s}`),h.push(` :${i(u,l)}`)):h.push(` ,${i(u,l)}`),p++),u=_(u,7)}return["BEGIN:VEVENT",`UID:${crypto.randomUUID()}@${c}`,`DTSTAMP:${i(new Date,f)}`,`SUMMARY:${m(e.name,9)}`,...d,`LOCATION:${m(e.location,10)}`,`DTSTART;TZID=${s}:${i(I(e.startHm,n,e.weekday),l)}`,`DTEND;TZID=${s}:${i(I(e.endHm,n,e.weekday),l)}`,...h,"END:VEVENT"]}function K(e){const n=document.createElement("div");n.innerHTML=e;const t=n.textContent;return n.remove(),t!=null?t:""}if(document.location.pathname!=="/sinh-vien/ket-qua-dkhp"){$.alert({type:"red",title:"Wrong location",content:"You are in the wrong place. To export your timetable, go to https://portal.ctdb.hcmus.edu.vn/sinh-vien/ket-qua-dkhp.",buttons:{ok:{text:"Take me there",btnClass:"btn-blue",action:()=>{document.location="/sinh-vien/ket-qua-dkhp"}},cancel:{text:"Cancel"}}});return}const R=document.querySelector(".ModCTDBSVKetQuaDKHPC");if(!R){$.alert({type:"red",title:"Could not find timetable",content:'Cannot export timetable if it does not exist. If you think this is an error, please <a href="https://github.com/beerpiss/hcmus-ctda-calendar/issues">contact the developer</a>.',buttons:{ok:{text:"OK"}}});return}const O=ko.dataFor(R),b=O.dsKetQuaDKHP();if(console.log(`ketQuaDKHP: ${JSON.stringify(b)}`),b.length===0){$.alert({title:"Nothing to export",content:'Seems like you have no subjects this semester. Have fun! If you think this is an error, please <a href="https://github.com/beerpiss/hcmus-ctda-calendar/issues">contact the developer</a>.',buttons:{ok:{text:"OK"}}});return}const w=["BEGIN:VCALENDAR",`PRODID:-//${c}//${a}//VI`,"VERSION:2.0","BEGIN:VTIMEZONE","TZID:Asia/Ho_Chi_Minh","TZURL:http://tzurl.org/zoneinfo-outlook/Asia/Ho_Chi_Minh","X-LIC-LOCATION:Asia/Ho_Chi_Minh","BEGIN:STANDARD","TZOFFSETFROM:+0700","TZOFFSETTO:+0700","TZNAME:+07","DTSTART:19700101T000000","END:STANDARD","END:VTIMEZONE"];for(const e of b){let n=null;const t=N[e.HocKy];if(!t){$.alert({type:"red",title:"Error",content:`Start and end dates for semester ${e.HocKy} has not been added. Please <a href="https://github.com/beerpiss/hcmus-ctda-calendar/issues">contact the developer</a>.`,buttons:{ok:{text:"OK"}}});return}const o={};if(e.GVTroGiang&&(o["Tr\u1EE3 gi\u1EA3ng"]=e.GVTroGiang.replace(T,", ")),e.GhiChu&&(o["Ghi ch\xFA"]=K(e.GhiChu).replace(/^Ghi chÃº:\s*/,"")),e.LichHocLT){const r=`[${e.KyHieu}] [LT] ${e.TenMH}`;for(const d of k(e.LichHocLT))n=Z(E({},d),{name:r,extras:E({"Gi\xE1o vi\xEAn":e.GVLyThuyet.replace(T,", ")},o)}),w.push(...A(n,t.theory.start,t.theory.end,t.breaks))}if(e.LichHocTH){const r=`[${e.KyHieu}] [TH] ${e.TenMH}`;for(const d of k(e.LichHocTH))n=Z(E({},d),{name:r,extras:E({"Gi\xE1o vi\xEAn":e.GVThucHanh.replace(T,", ")},o)}),w.push(...A(n,t.practice.start,t.practice.end,t.breaks))}}w.push("END:VCALENDAR");const G=w.join(`\r
`),U=O.selectedMaHK(),S=O.dsHocKy().find(e=>e.MaHK===U),V=S?`${S.TenHK}.ics`:"Unknown Semester.ics",y=document.createElement("a");y.href=`data:text/calendar,${encodeURIComponent(G)}`,y.download=V,y.click(),y.remove(),toastr.success("The timetable was successfully exported.")});

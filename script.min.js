"use strict";var F=Object.defineProperty,q=Object.defineProperties;var Y=Object.getOwnPropertyDescriptors;var v=Object.getOwnPropertySymbols;var B=Object.prototype.hasOwnProperty,Q=Object.prototype.propertyIsEnumerable;var x=(i,a,s)=>a in i?F(i,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[a]=s,Z=(i,a)=>{for(var s in a||(a={}))B.call(a,s)&&x(i,s,a[s]);if(v)for(var s of v(a))Q.call(a,s)&&x(i,s,a[s]);return i},k=(i,a)=>q(i,Y(a));var _=(i,a,s)=>new Promise((g,T)=>{var N=d=>{try{l(s.next(d))}catch(m){T(m)}},E=d=>{try{l(s.throw(d))}catch(m){T(m)}},l=d=>d.done?g(d.value):Promise.resolve(d.value).then(N,E);l((s=s.apply(i,a)).next())});_(this,null,function*(){"use strict";if(!$.alert){const e=document.createElement("link");e.rel="stylesheet",e.type="text/css";const n=new Promise(c=>e.addEventListener("load",c));e.href="/plugins/jquery-confirm/dist/jquery-confirm.min.css",document.head.appendChild(e);const t=document.createElement("script"),o=new Promise(c=>t.addEventListener("load",c));t.src="/plugins/jquery-confirm/dist/jquery-confirm.min.js",document.head.appendChild(t),yield Promise.all([n,o])}const i="ctdacalendar",a="CTDA Timetable Exporter",s="Asia/Ho_Chi_Minh",g=["T2","T3","T4","T5","T6","T7","CN"],T=/<\s*br\s*\/?\s*>/gu,N={"1/24-25":{theory:{start:new Date("2024-09-30T00:00:00Z"),end:new Date("2024-12-15T00:00:00Z")},practice:{start:new Date("2024-10-07T00:00:00Z"),end:new Date("2024-12-15T00:00:00Z")},breaks:[{start:new Date("2024-11-04T00:00:00Z"),end:new Date("2024-11-10T00:00:00Z")}]},"2/24-25":{theory:{start:new Date("2025-01-06T00:00:00Z"),end:new Date("2025-04-13T00:00:00Z")},practice:{start:new Date("2025-01-13T00:00:00Z"),end:new Date("2025-04-13T00:00:00Z")},breaks:[{start:new Date("2025-01-20T00:00:00Z"),end:new Date("2025-02-09T00:00:00Z")},{start:new Date("2025-03-03T00:00:00Z"),end:new Date("2025-03-09T00:00:00Z")}]},"3/24-25":{theory:{start:new Date("2025-05-12T00:00:00Z"),end:new Date("2025-08-17T00:00:00Z")},practice:{start:new Date("2025-05-19T00:00:00Z"),end:new Date("2025-08-17T00:00:00Z")},breaks:[{start:new Date("2025-06-16T00:00:00Z"),end:new Date("2025-07-13T00:00:00Z")}]}},E=new Intl.DateTimeFormat("vi-VN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1,timeZone:"UTC"}),l=new Intl.DateTimeFormat("vi-VN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1,timeZone:s});function d(e,n){const t={};for(const o of n.formatToParts(e))t[o.type]=o.value;return`${t.year}${t.month}${t.day}T${t.hour}${t.minute}${t.second}`}function m(e,n=0){const t=e.length;let o=75-n,c=e.substring(0,75-n);for(;o<t;){const r=e.substring(o,o+75);c+=`\r
 ${r}`,o+=75}return c}function*A(e){const n=e.split(T);for(const t of n){const o=t.match(new RegExp("(?<dow>T[2-7]|CN) (?<start>\\d{1,2}:\\d{1,2})-(?<end>\\d{1,2}:\\d{1,2}) (?:\\((?<class>.+?)\\))?"));if(!o||o.length!==5)throw new Error(`Schedule was not in correct format: ${t}`);const[c,r,u,y,p]=o,h=g.indexOf(r);if(h===-1)throw new Error(`Unknown weekday: ${r}`);const D=u.split(":");if(D.length!==2)throw new Error(`Cannot parse start hour: ${u}`);const f=D.map(C=>Number(C)),M=y.split(":");if(M.length!==2)throw new Error(`Cannot parse end hour: ${y}`);const j=M.map(C=>Number(C));yield{weekday:h,startHm:f,endHm:j,location:p!=null?p:null}}}function I(e,n,t){return new Date(+n+t*864e5+(e[0]-7)*36e5+e[1]*6e4)}function G(e,n){const t=new Date(e.valueOf());return t.setDate(e.getDate()+n),t}function L(e,n,t,o=[]){const c=Object.entries(e.extras),r=[];if(c.length!==0){const h=c.map(([D,f])=>`${D}: ${f}`).join("\\n");r.push(`DESCRIPTION:${m(h,13)}`)}const u=[`RRULE:FREQ=WEEKLY;UNTIL=${d(t,E)}`],y=I(e.startHm,n,e.weekday);if(o.length>0){let h=y,D=0;for(;h<t;)o.some(f=>f.start<=h&&h<=f.end)&&(D===0?(u.push(`EXDATE;TZID=${s}`),u.push(` :${d(h,l)}`)):u.push(` ,${d(h,l)}`),D++),h=G(h,7)}const p=["BEGIN:VEVENT",`UID:${crypto.randomUUID()}@${i}`,`DTSTAMP:${d(new Date,E)}`,`SUMMARY:${m(e.name,9)}`,...r];return e.location!==null&&p.push(`LOCATION:${m(e.location,10)}`),p.push(`DTSTART;TZID=${s}:${d(I(e.startHm,n,e.weekday),l)}`,`DTEND;TZID=${s}:${d(I(e.endHm,n,e.weekday),l)}`,...u,"END:VEVENT"),p}function K(e){const n=document.createElement("div");n.innerHTML=e;const t=n.textContent;return n.remove(),t!=null?t:""}if(document.location.pathname!=="/sinh-vien/ket-qua-dkhp"){$.alert({type:"red",title:"Wrong location",content:"You are in the wrong place. To export your timetable, go to https://portal.ctdb.hcmus.edu.vn/sinh-vien/ket-qua-dkhp.",buttons:{ok:{text:"Take me there",btnClass:"btn-blue",action:()=>{document.location="/sinh-vien/ket-qua-dkhp"}},cancel:{text:"Cancel"}}});return}const R=document.querySelector(".ModCTDBSVKetQuaDKHPC");if(!R){$.alert({type:"red",title:"Could not find timetable",content:'Cannot export timetable if it does not exist. If you think this is an error, please <a href="https://github.com/beerpiss/hcmus-ctda-calendar/issues">contact the developer</a>.',buttons:{ok:{text:"OK"}}});return}const O=ko.dataFor(R),b=O.dsKetQuaDKHP();if(console.log(`ketQuaDKHP: ${JSON.stringify(b)}`),b.length===0){$.alert({title:"Nothing to export",content:'Seems like you have no subjects this semester. Have fun! If you think this is an error, please <a href="https://github.com/beerpiss/hcmus-ctda-calendar/issues">contact the developer</a>.',buttons:{ok:{text:"OK"}}});return}const w=["BEGIN:VCALENDAR",`PRODID:-//${i}//${a}//VI`,"VERSION:2.0","BEGIN:VTIMEZONE","TZID:Asia/Ho_Chi_Minh","TZURL:http://tzurl.org/zoneinfo-outlook/Asia/Ho_Chi_Minh","X-LIC-LOCATION:Asia/Ho_Chi_Minh","BEGIN:STANDARD","TZOFFSETFROM:+0700","TZOFFSETTO:+0700","TZNAME:+07","DTSTART:19700101T000000","END:STANDARD","END:VTIMEZONE"];for(const e of b){if(!e.LichHocLT&&!e.LichHocTH)continue;let n=null;const t=N[e.HocKy];if(!t){$.alert({type:"red",title:"Error",content:`Start and end dates for semester ${e.HocKy} has not been added. Please <a href="https://github.com/beerpiss/hcmus-ctda-calendar/issues">contact the developer</a>.`,buttons:{ok:{text:"OK"}}});return}const o={};if(e.GVTroGiang&&(o["Tr\u1EE3 gi\u1EA3ng"]=e.GVTroGiang.replace(T,", ")),e.GhiChu&&(o["Ghi ch\xFA"]=K(e.GhiChu).replace(/^Ghi chÃº:\s*/,"")),e.LichHocLT){const c=`[${e.KyHieu}] [LT] ${e.TenMH}`,r={};e.GVLyThuyet&&(r["Gi\xE1o vi\xEAn"]=e.GVLyThuyet.replace(T,", ")),Object.assign(r,o);for(const u of A(e.LichHocLT))n=k(Z({},u),{name:c,extras:r}),w.push(...L(n,t.theory.start,t.theory.end,t.breaks))}if(e.LichHocTH){const c=`[${e.KyHieu}] [TH] ${e.TenMH}`,r={};e.GVThucHanh&&(r["Gi\xE1o vi\xEAn"]=e.GVThucHanh.replace(T,", ")),Object.assign(r,o);for(const u of A(e.LichHocTH))n=k(Z({},u),{name:c,extras:r}),w.push(...L(n,t.practice.start,t.practice.end,t.breaks))}}w.push("END:VCALENDAR");const V=w.join(`\r
`),U=O.selectedMaHK(),S=O.dsHocKy().find(e=>e.MaHK===U),P=S?`${S.TenHK}.ics`:"Unknown Semester.ics",H=document.createElement("a");H.href=`data:text/calendar,${encodeURIComponent(V)}`,H.download=P,H.click(),H.remove(),toastr.success("The timetable was successfully exported.")});
